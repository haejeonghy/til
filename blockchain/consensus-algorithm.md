# Consensus Algorithm

* 합의 알고리즘
* 다수의 참여자들이 통일된 의사결정을 하기 위해 사용하는 알고리즘
* 합의 모델, 합의 방식, 합의 메커니즘, 합의 프토토콜
* 블록체인 시스템의 경우 네트워크에 참여하는 모든 참여자들이 동일한 데이터를 복사하여 분산 저장하기 때문에 원본과 사본의 구별이 없다.
* 통일된 의사결정을 내릴 수 있는 권위 있는 중앙이 존재하지 않는다.
* 블록체인 데이터는 중앙화된 서버 대신 전세계에 흩어져있는 수많은 노드에 보관되기 때문에 각각의 노드들은 블록에 기록하는 데이터가 위변조되지 않은 원보이라는 것을 상호간에 합의하는 과정이 필요하다.
* 블록을 생성하는, 특정 노드가 악의를 품고 조작된 데이터를 저장하거나 네트워크에 전파한다면 시스템 전체의 신뢰도가 떨어질 것이다.
* 악의적인 상황이 발생하더라도 네트워크를 올바른 방향으로 이끌고자 하는 다수의 노드들이 상호 검증을 거쳐 올바른 블록 생성을 이끌어내는 프로세스와 알고리즘
* 각 블록체인에서 우선시하는 가치와 용도에 따라 다양한 합의 알고리즘을 선택한다.

* 고려하여할 사항
  * finality problem 완결성 문제
  * 51% attack/BFT 51% 공격과 비잔틴 결함
  * transaction cost 트랜잭션 수수료

## Proof of Work

* PoW
* 작업 증명
* 유효한 블록을 만드는데 충분한 계산 자원을 소모했다는 증명
* 사토시 나카모토가 제안안 합의 알고리즘
* 블록생성 시간동안 가장 많은 해시파워를 제공한 노드가 블록을 생성할 수 있도록 설계한다.
* 네트워크에서 수용할 값을 제안하기 전에 충분한 컴퓨팅 자원을 소모했다는 증명
* 비트코인, 라이트코인 등 여러 암호화폐 블록체인에서 사용된다.
* Mining
  * 마이닝
  * 블록을 생성하기 위해 논스라는 임의의 값을 맞히는 과정
  * 블록체인 네트워크에 전송된 암호화된 거래정보를 새로운 블록에 담고, 새로운 블록을 체인에 연결하는 작업을 완료했다는 걸 증명하는데 사용되는 컴퓨팅 파워
  * 브랜치가 생긴 경우 가장 긴 블록체인이 남을 때까지 서로 경쟁하여 이긴 브랜치가 최종적인 브랜치로 채택이 되고 다른 브랜치는 버려진다.
* 시빌 공격과 같은 블록체인 네트워크에 대한 각종 공격을 막을 수 있다고 증명된 유일한 알고리즘
  * Sybil Attack
  * 격자가 실제로는 한 명이면서 마치 여러 명인 것처럼 속이는 방식으로 네트워크상의 여러 노드를 제어함으로써, 의사결정에 좋지 않은 영향을 미치는 공격
* 채굴 경쟁에서 지면 nonce에 90%이상 근접했다고 하더라도 새로운 블록을 채굴하는게 더 효율적이다.
  * 채굴에 성공한 하나의 노드를 제외한 나머지 모든 노드들은 에너지 자원을 낭비할 뿐이다.
* 높은 전력 소모를 통해 자원을 낭비한다.
* 지속적으로 해시파워를 유지해야 한다.
* 특정 마이닝 세력의 해시 독점으로 인한 생태계 교란 우려가 있다.
* 현재 높은 시장 가치를 형성하고 있는 주류 코인들이 채택하고 있다.
* 강력한 보안성을 제공한다.
* 서비스 남용을 쉽게 방지할 수 있다.
* 느랜 트랜잭션 문제
* 고스트 프로토콜을 사용하여 블록이 결정된다.
  * ghost protocol
  * 메인체인을 선택하는데 있어 가장 긴 체인을 선택하는 알고리즘
  * 어느 체인이 가장 긴 것인지 계산할 때 고아 블록도 포함하므로써 네트워크 보안 손실 문제를 해결한다.
  * 어느 블록이 가장 큰 전체 작업 증명을 가지고 있는지 계산함에 있어 그 블록의 부모 블록, 조상 블록, 고아 자손까지 더한다.
* 비트코인, 라이트코인, 비트코인 캐시 등
* 어떤 트랜잭션이 발생했을 경우 해당 트랜잭션이 유효한 트랜잭션인지에 대해 합의해 해결한다.
* 새로운 블록이 진짜인지 가짜인지 검증을 수행한다.
* 작업 증명
  * 반복적인 과정을 통해 무작위로 특정한 조건보다 낮은 값 nonce 를 찾아내어 그에 대한 대가로 비트코인을 받게 된다.
  * 무작위의 논스값을 찾아내기 위해 비트코인에서는 SHA-256방식을 이용하는데 이 과정에서 컴퓨터의 계산 능력이 필요하고, 다른 컴퓨터가 같은 문제를 풀기 위해 경쟁한다.
  * 경쟁을 통해 하나의 블록이 생성되므로 블록 생성에 성공한 블록 외에 다른 컴퓨터가 사용한 전력을 고스란히 낭비된다.
  * 해시파워가 높을수록 원하는 값을 얻기 쉬워지지만 그러려면 엄청난 금액의 채굴기와 전기료를 감당해야 한다. 

  ```
  작업 증명(PoW)의 식
  여기서 N은 논스(Nonce)이고, P_hash는 이전 블록의 해시, Tx는 블록의 트랜잭션을 나타내며, Target은 네트워크의 난이도 목표 값입니다. 
  이 식의 의미는 필드들을 연결한 값의 해시가 목표 해시 값보다 작아야 한다는 뜻입니다.

  H(N || P_hast || Tx || Tx || ...Tx) < Target
  ```

    * 논스를 찾는 방법은 무차별 대입 방법밖에 없다.
    * 특정 개수의 0이 있는 패턴을 찾은 채굴자는 블록을 즉시 브로드캐스팅하고 다른 채굴자들은 블록을 승인하게 된다.
* 장점
  * 높은 보안성
    * 51% 공격을 쉽게 방어할 수 있다.
    * 현실적으로 작업 증명에서 51% 이상을 획득하는 것은 천문학적인 비용이 발생하기 때문에 어렵다.
* 단점
  * 채굴 난이도가 높아지면서 개인 채굴자는 채굴을 할 수 없는 수준까지 도달했다.
  * 연산에 고사양 장비가 필요하게 됐다.
  * 과도한 전력소모로 에너지 낭비가 커졌다.
  * 비트코인 채굴에 소모되는 전력략이 연간 약 48테라와트시로 추정된다.
  * 기업형 채굴자들이 등장하고 단합으로 채굴권이 집중되는 문제가 발생한다.
    * 탈 중앙으로부터 멀어진다.

## Proof of Stake

* PoS
* 노드 또는 사용자가 시스템에 충분한 지분을 갖고 있다는 증명
* 노드가 보유하고 있는 지분의 양을 기준으로 블록 생성 권한을 부여한다.
* 암호화폐를 보유하고 있는 지분율에 비례하여 의사결정 권한을 주는 합의 알고리즘
* 스테이킹(staking)한 자산을 통해 블록을 생성하게 된다.
* 지분의 크기만큼 다음 블록의 검증 노드로 선택될 확률이 결정된다.
  * 블록 형성 권한과 거래 수수료를 보상으로 받게 된다.
* 지분 증명 알고리즘은 노드 또는 사용자가 시스템에 충분한 지분을 갖고 있다는 아이디어에서 출발한다.
  * 지분을 많이 가지고 있는 노드에게 블록을 생성할 권한을 준다.
  * 네트워크 참여자 모두가 블록을 검증할 수 있는 기회를 갖게 된다.
  * 작업이 아닌 더 많은 지분(해당 코인)을 가지고 있을 수록 그에 비례하여 블록에 기록할 권한이 더 많이 부여된다.
    * 블록 검증 기회를 더 얻을 수 있다.
  * 재산에 비례하여 보상이 주어진다.
* 채굴자에게는 이자와 같은 방식으로 코인이 지급된다.
* 일정 수 이상의 코인을 보관하고 있는 지갑을 블록체인 네트워크에 연결시켜놓기만 하면 보상을 받을 수 있다.
* 블록 생성자와 지분 생성자의 이해관계를 일치시킴으로써 블록을 나쁜 의도로 생성할 동기부여를 없애고, 잘못 생성할 경우 패널티를 부여한다.
* PoW보다 에너지 소모가 적고, 코인을 가진 노드 누구나 네트워크에 허가 없이 참여하기 때문에 분산화가 더 잘 되어 많은 노드가 의사결정 과정에 쉽게 참여할 수 있는 이점이 있다. 
* 이더리움이 작업 증명 방식에서 지분 증명 방식으로 합의 알고리즘으로 변경하려고 한다.
* 검증되지 않았기 때문에 보안성이 강한지 확인되지 않았다.
* 지분이 많은 고래들이 권력을 독점할 가능성이 존재한다.
* 무의미하게 논스 값을 찾거나 할 필요가 없어 해시파워가 많이 필요하지 않으므로 경제적이며 친환경적이다.
* 비싼 하드웨어가 필요하지 않고 전기를 많이 소모하지 않으며 다른 코인으로 이탈 가능성이 적다.
  * 오랜 코인을 보유해야 하는 조건 때문
  * 검증 시간이 짧다.
* 블록 생산자의 탈중앙화로 안정성을 확보할 수 있다.
* 블록을 생성하기 위해 지분을 담보로 잡아야하기 때문에 dumping을 방지할 수 있다.
* 내성 빠른 트랜잭션
* 에너지 낭비가 적다. 
* 완결성 문제, 검증 부족
* 퀀텀, 네오, 스트라디스
* 장점
  * 환경 친화적 시스템
    * 작업증명 방식과 대조적으로 에너지 소모가 큰 프로세스가 없다.
  * 인센티브에 대한 강한 동조 및 지지
    * 합의 대리인을 직접적으로 암호화폐에 투자하게 만들고 그에 따라 투자자와 합의 대리인의 이해관계가 같아지게 되는 특징이 있다.
  * 채굴 풀의 중앙 집중화 해결
    * 탈 중앙화에 적합한 대안이다.
  * 네트워크 참여자를 확보하기 수월하다.
    * 별도의 채굴 장비를 필요로 하지 않는다.
    * 지분의 보유가 곧 블록생성 기회이기 때문에 경제적 유인이 분명하다. 
    * 확보한 네트워크 참여자들로 인해 탈중앙화 원칙을 강화할 수 있다.
* 단점
  * 불완전한 해결책
    * 체인 선택에 대한 해결책만 제시했지 나머지 문제점에 대한 해답을 제시하지 못했다.
  * 불공평한 경제모델
    * 암호화폐 보유량에 따라 신규 자금을 배당한다.
    * 소수의 사람들에게 자금이 집중될 수 있다는 것을 의미한다.
    * 보상 시스템이 쓸모없고 인센티브를 전혀 제공하지 못한다고 비춰질 수 있다.
  * nothing at stake problem
    * 위험에 노출되지 않는 문제
    * 최대 문제점
    * 블록 작성자가 네트워크 분기가 될 때 위험에 처하지 않는다.
      * 회사 사장님을 때려도 직장을 게속 다닐 수 있는 문제
      * 나쁜 행동을 억제하고 있다.
    * 모든 노드들이 제한 없이 여러 블록에 자신의 지분을 증명할 수 있다.
    * 만약 하나의 거래에서 서로 다른 거래 내용이 발생한 경우 많은 지분을 가진 노드가 공격을 목적으로 두 개의 블록에서 모두 증명을 해놓고 거짓인 체인도 참인것 처럼 길게 체인을 형성할 수 있다.
    * 블록에 새로 참여한 검증자는 어느 것이 정당한 블록체인인지 알 수 있는 방법이 없다.
    * 새로 많은 지분을 사들여 검증에 참여하는 노드가 거짓인 블록체인에 증명(합의)를 해버릴 경우 제대로 된 거래를 한 사람은 모두 공격에 당하게 된다.
  * 권위가 명확하게 발생한다.
    * 지분 보유량에 따라 빈부격차가 발생한다.
    * 극단적인 경우 특정 노드가 블록생성 기회를 독점할 수 있다. 
    * 포크 상황이 발생했을 때 분산화 원칙이 심하게 훼손될 우려가 있다.
      * 장악이 어렵고 비용이 많이 들기 때문에 하지는 않는다.
    * 탈중앙화 원칙이 권위를 가진 자들의 이익을 위해 유지 또는 강화된다.

## Delegated Proof of Stake

* DPoS
* 위임 지분 증명
* PoS에서 변형된 것
* 노드들간의 투표를 통해 상위 노드를 선정하고 블록 생성 권한을 모두 위임한다.
* 투표를 블록체인 거버넌스에 도입함으로써 분산화를 유동적으로 관리한다.
  * 투표를 통해 권위가 생성된다.
  * 생성된 권위가 개별 노드의 지지 철회를 도입함으로써 분산화를 유동적으로 관리한다.
  * 이렇게 생성된 권위는 개별 노드의 지지 철회를 통해 언제든 소멸될 수 있다.
  * 선출된 상위 노드는 탈중앙화 원칙을 유지하기 위해 노력할 수 밖에 없다.
    * 분산화 원칙이 개별 노드들의 주관적 판단에 의해 좌우된다.
* 암호화폐 소유자들이 각자의 지분율에 비례하여 투표권을 행사하여 자신의 대표자를 선정하고 선정된 대표자들끼리 합의하여 의사 결정을 내리는 합의 알고리즘
* 특정 인원에게만 지분 증명을 할 수 있도록 권한을 위임한다.
* 누구나에게 대표자가 될 기회가 주어지지 않는다.
  * 대표자가 되기 위해서는 투표를 거쳐야 한다.
  * 선출된 대표자들은 블록을 생성하고, 블록을 확정하기 위해서는 2/3 이상의 승인이 필요하다.
  * 대표자의 지위는 일정 시간 이내에 블록 셋업에 참여해야 유지된다.
* 시스템의 지분을 가진 각 노드가 투표를 통해 트랜잭션의 유효성 검사를 다른 노드에 위임하여 증명하는 개념
* EOS에서 사용이 된다.
  * EOS : 위임지분증명 방식을 사용하는 제 3세대 암호화폐
* 모든 노드의 자격을 가진 주주들이 블록 생성에 참여하는 대신, 네트워크의 모든 노드의 투표 결과로 선출한 '상위 노드' (스팀에서는 증인, witness)에게 권한을 위임해 합의하도록 하는 방식. Validator
* 일정 수의 증인들은 모든 권한을 위임받아 블럭 생성을 담당한다.
* 미국 대선의 대의원 제도 같은 간접선거 방식에 비유할 수 있다.
* 댄 라리머 DPoS를 사용하는 그라핀 (Graphene) 엔진을 토대로 스팀과 빗쉐어를 만들고 이에 대한 성능을 증명했다.
* 합의에 참여하는 노드의 수가 한정되어 있기 때문에 매우 빠른 성능과 확장성을 보이고 있지만 완전히 탈중앙화된 블록체인이 아니라는 비판을 받고 있다.
* PoS에 비해 많은 트랜잭션을 빠르게 처리가능하다. 
* PoW에 비해 비용이 낮다.
* 하드포크의 위험이 낮다.
  * hardfork : 블록체인 기본 기능 자체를 수정하는 포크
* 증인들이 투표에 참여할 인센티브가 분명하다.
* 증인끼리 손쉽게 담합할 위험이 있다.
* 공개된 소수의 증인에 대한 디도스 공격 위험이 있다. 
* 신뢰도는 증인의 신뢰도에 종속된다.
* 에너지 낭비가 적다. 
* 스팀, 이오스, 아크, 라이즈
* 장점
  * 소규모 참여자도 이득을 볼 수 있다.
  * 거래 속도(TPS)가 빠르다.
  * 같은 시간에 훨씬 더 많은 거래를 처리할 수 있다.
  * 수수료가 없다.
* 단점
  * 네트워크 보안
    * 위임지분증명 방식의 경우 지분을 위임받은 대표자들의 수가 제한되어 있다.
    * 탈중앙화가 되지 않아 보안에 취약할 수 있다.
    * 대표자를 선출하고자 하면 대표자에 대한 정보를 밝혀야 한다.
      * 탈중앙화된 네트워크가 외부 공격에 강한 이유가 익명성 때문인데, 이를 어기게 된다.
  * 대표자의 수
    * 네트워크가 커짐에도 불구하고 대표자의 수가 일정하다면 상대적인 중앙화가 이루어질 수 있기 때문에 암호화폐 보유자 수가 많아질수록, 네트워크가 커질 수록 대표자 수가 늘어나야 한다.
    * 대표자 수가 증가하면 위임지분증명의 장점인 속도가 느려지게 된다.

## 경과 시간 증명

* PoET
* 경쟁적 연산으로 낭비되는 에너지를 줄이면서 작업 증명과 유사 효과
* 하이퍼레저 쏘투스 레이크 (Sawtooth Lake)에서 제안
* 인텔 SGX을 기반으로 블록을 생성하는 리더를 랜덤으로 선정한다.
* 검증된 방법의 개선
* 에너지 낭비가 적다.
* 특정 HW에 종속된다.
* 쏘투스

## 프라이빗 허가형 컨소시엄

* PBTF
* 참가자 한 명이 프라이머리(리더)가 되어 모든 참가자에게 요청 송신
* 그 요청에 대한 결과를 집계한 뒤 다수의 값을 사용해 블록을 확정한다.
* 각 노드는 브로드캐스트 된 명령을 받게 되면 모든 노드에 회신한다.
* 각 노드는 명령을 일정 수 이상 수신하면 명령을 실행하고 블록을 등록한다.
* 완결성 문제 해결
* 빠른 트랜잭션
* 참여자 사전 파악 필요
* 참가자 증가시 성능이 하락된다.
* 페브릭

## 권한 증명

* PoA
* 트랜잭션 및 블록의 Validator라고 승인된 계정에 의해 유효성이 검사
* Validator의 권리를 얻으므로 그들이 얻은 지위를 유지하고자 함
* 자신의 신원에 부정적 평판이 생기길 원치 않도록 노력할 거라 가정

## PAXOS

* 트랜잭션 및 블록의 validator라고 승인된 계정에 의해 유효성이 검사
* validator가 될 수 있는 권리를 얻으므로 그들이 얻은 지위를 유지하고자 함
* 자신의 신원에 부정적인 평판이 생기길 원치 않도록 노력할 것이라 가정

## 비잔틴 장애 허용

* BFT
* Byzantine Fault Tolerance
* 장애가 있더라도 전체의 3분의 1을 넘지 않는다면 시스템이 정상 가동하도록 허용하는 합의 알고리즘
* 블록체인 분산원장 체계가 제대로 돌아가기 위해서는 원장을 공유하는 참여자들이 정직하게 행동해야 하며 이를 보장할 방법이 있어야 한다.

## RAFT

* 리더를 선정한 후 시스템의 모든 변화를 리더를 통해 결정
* 신뢰된 네트워크에서만 사용
* 리더의 조작 가능
* BTF 보장하지 않음

## Sieve

* IBM에서 고안한 PBFT 확장 알고리즘
* 실행결과 전송과 집계 결과 전송으로 흐름이 나뉜다.

## 프랙티컬 비잔틴 장애 허용

* PBFT
* Practical Byzantine Fault Tolerance
* 네오, 질리카, 하이퍼레저, R3, ITC, 텐더민트 등에서 사용하는 합의 알고리즘
* 여러 노드로 구성된 네트워크에서 악의적 공격을 방어하기 위해 만들어졌다. 

## 합의 알고리즘의 종류

* safety 와 liveness를 모두 만족시켜야 한다.
* liveness over safety
  * 잘못된 합의가 이루어질 수 있지만 어떻게든 합의는 한다.
  * 블록체인 PoW
* Safety over liveness
  * 잘못될 가능성이 있다면 블록을 만들지 않는다. 
  * cosmos tendermint

## 거버넌스 블록체인

* governance
  * 거버넌스
  * 과거의 일방적인 정부 주도적 경향에서 벗어나 정부, 기업, 비정부기구 등 다양한 행위자가 공동의 관심사에 대한 네트워크를 구축하여 문제를 해결하는 새로운 국정운영의 방식
  * 블록체인을 통해 참여자들의 이익을 대변한 네트워크 구조를 만들어낼 수 있게 되고, 현실과 마찬가지로 하나의 세계가 생성된다.
  * 세계를 유지하기 위해 구성원들간의 이해관계 조정을 위해 의사 통합이 중요해지는데 이때 필요하게 된다.
* blockchain governance
  * 블록체인 거버넌스
  * 블록체인 안에서의 거버넌스
  * 효율성의 측면 때문에 투표가 가장 일반적으로 사용된다.
  * 비트코인, 이더리움의 BIP, EIP 및 개발자, 여러 커뮤니티를 통해 네트워크의 방향성을 정한다.
  * 다양한코인들이 조금씩 다른 방식으로 거버넌스를 구성한다.
  * klaytn에서도 governance의 형태를 띄고 있다. 

## klaytn 합의 매커니즘

* 노드 유형
  * CN
    * 컨센서스 노드
    * CCO Core Cell Operator에 의해 관리되며 블록 생성을 담당한다. 
  * PN
    * 프록시 노드
  * EN
    * 엔드포인트 노드
    * 레인저 노드
* IBFT
  * Istanbul Byzantine Fault Tolerance
  * 블록체인 네트워크의 특성을 반영하여 변형된 버전의 PBFT
  * 즉각적인 최종성을 보장하는 권한증명 블록체인 합의 알고리즘
  * 기본적으로 PBFT의 형식을 따라가며 블록을 모아 전송한다.
  * 동적 유효성 검사기 집합이 있다는 점에서 PBFT와 다르다.
    * PBFT 합의 매커니즘 기반 체인보다 빠르게 트랜잭션을 확인할 수 있다.
  * 작동 방식
    1. 시작하기 위해 노드 그룹이 선택되어 유효성 검사기 풀을 구성한다.
       1. 이 노드는 제안된 블록이 체인에 추가하기에 적합한지 여부를 결정한다.
    2. 검증자 노드 중 하나가 제안자로 임의로 선택된다.
    3. 검증자 풀에서 메시지를 받은 이 단일 제안자는 체인에 무엇을 추가할지 결정한다.
       1. 이것은 다른 검증자에게 제안된 블록으로 제시된다.
    4. 대다수의 검증인이 블록이 유효하다고 간주하는 경우에만 원장에 추가된다.
    5. 각 합의 라운드가 끝나면 검증자가 새로운 제안자를 선택하고 프로세스가 반복된다. 