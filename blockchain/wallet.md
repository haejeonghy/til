# Wallet

* 지갑
* 블록체인에서 실행되고 개인과 공개 키를 저장하고 해당 키와 관련된 모든 트랜잭션을 블록 체인에 모니터링하고 유지하는 소프트웨어
* 비트코인, 이더리움 등 암호화폐를 보관할 수 있는 계정
* 채굴과 노드에서 노드가 지갑이다.
* 종류
  * 데스크탑 지갑
  * 모바일 지갑
  * 하드웨어 지갑
  * 웹 지갑
* 구조
  * 공개 키 public key
    * 다른 사람들이 암호화폐를 송금할 수 있도록 공개해도 된다.
  * 암호 private key
    * 지갑 소유자 본인만 알고 있어야 한다.

## 지갑의 유형

* 가상화폐를 사고 파는 거래 서비스나 상품 대금으로 지급하는 결제 서비스의 구현에 있어서 구현 방식에서 보안 취약점이 존재할 수 있다.
  * 가상화폐 거래를 손쉽게 해주는 가상화폐 거래소에 대한 보안 사고가 최근에 자주 발생하고 있다.
    * 가상화폐를 거래하는 사용자들의 피해자가 증가하고 있다.
* Hot wallet
  * 핫 월렛
  * 온라인에 연결되어 있는 암호화폐 지갑
  * 인터넷 상에 연결되어 있고 개인 키가 서버에 저장되어 있기 때문에 사용자가 쉽게 접근할 수 있으며, 실시간으로 거래를 할 수 있다.
  * 크롬 브라우저에서 사용하는 이더리움 플러그인인 메타마스크(MetaMask) 
    * 크롬 브라우저에 설치를 하는 지갑으로, 메타마스크가 사용자 정보를 보관하고, 사용자는 비밀번호만 입력하면 암호화폐를 사용할 수 있다.
  * 인터넷 엑세스가 개인 정보 및 보안에 미치는 위험 때문에 덜 안전하다.
  * 사용자 친화적이다.
  * 작은 일상 거래를 위한 월렛
  * 보안적 문제
    * 인터넷에 접속해야 사용할 수 있다.
    * 인터넷에 연결되어 있을 경우, 악의적인 해커에 의해 탈취당할 수 있어 보안에 취약하다.
      * 2018년 일본 암호화폐 거래소인 코인체크(Coincheck)는 약 580억 엔(한화 약 5,700억 원)이 탈취당한 사례
        * 일반적으로 암호화폐 거래소는 사용자 지갑에 있는 여러 개인 키를 사용해야 출금이 가능하도록 하는 멀티시그 방식을 사용한다.
          * 멀티시그 방식을 사용하면, 개인 키 일부가 유출되어도 출금을 진행할 수 없기 때문에 개인 키 하나로 출금을 진행하는 방식과 비교했을 때 비교적 안전하다.
        * 코인체크에서는 단일 키를 사용하여 지갑을 관리했다.
          * 단일 키가 한번 해킹당하자, 개인 키에 연결된 자산이 모두 출금된 것이다.
        * 대부분의 거래소에서는 자산의 일부만 핫 월렛에 보관하고, 대부분의 자산은 오프라인에 보관한다.
* cold wallet
  * 콜드 월렛
  * 암호화폐의 콜드 스토리지에 사용되는 암호화폐 지갑 유형
  * 보안 강화를 위해 오프라인에 저장된다.
  * 금고에 가깝다.
  * 장기 보유를 위한 월렛
  * 지갑의 개인 키를 오프라인으로 보관하는 지갑을 의미
  * 개인 키를 USB나 카드에 보관하기 때문에 '하드웨어 월렛(Hardware Wallet)이라고도 한다.
  * 콜드 월렛으로 거래를 하기 위해서는 먼저 오프라인 상에서 트랜잭션을 생성하고, 이 트랜잭션을 온라인에 입력해야 한다.
  * 바로 거래를 할 수 있는 핫 월렛에 비해서는 번거롭다.
  * 트랜잭션을 온라인에 입력할 때를 제외하고는 오프라인 상태이기 때문에, 해킹의 위험이 비교적 적다.
  * 보안 때문에 많은 암호화폐 거래소에서는 일부 자산을 콜드 월렛에 보관한다.
    * 2019년 빗썸은 약 350억 원 규모의 암호화폐를 탈취당했다.
      * 사건 발생 직후 보유하고 있던 자산을 모두 콜드 월렛으로 이동시켜 보관하였다.
      * 코인을 오프라인으로 옮기면 해킹 가능성이 거의 없기 때문이다.
  * 하드 월렛을 잃어버리더라도 복구 문구(Recovery Phrase)만 알고 있으면 소유권을 증명할 수 있다.
  * 일반적으로 거래소에서는 거래소 전체 자산의 70%는 콜드 월렛에 안전하게 보관하며, 30%를 핫월렛에 보관한다.
    * 거래소에서 출금을 하는 경우, 거래소 데이터베이스에 저장되어 있는 개인키를 이용해 트랜잭션을 생성하는 방식으로 출금이 이루어진다.
* 다중 서명 월렛
  * multisig wallet
  * 다중 서명 암호화폐 지갑
  * 거래를 완료하기 위해 여러 당사자의 입력이 필요한 암호화폐 지갑 유형
  * 모든 당사자가 거래를 완료하기 위해 PIN을 입력하거나 주문해야 하는 공유 은행 계좌와 유사하다.
  * 가족과 기업 모두가 사용하기에 이상적이다.
* 다중 통화 월렛
  * multi-currency wallet
  * 여러 유형의 암호화폐를 모든 암호화폐에 대한 한 장소에 저장할 수 있다.
    * exodus
      * bitcoin, ether, eos, dash 등 통화 저장 가능
  * 일부 암호화폐 지갑에서는 암호화폐 A를 B로 변환할 수 있다. 
    * shapeshift 와 통합을 통해 수행된다.
    * 변환할 수 없는 경우 온라인에서 이를 수행하기 위해 추가 단계를 수행해야 한다.
    * 시작하기 전에 핫 월렛에 대한 shapeshift 통합을 찾는 것이 중요한 이유
* 웹 월렛
  * 웹 브라우저를 통해 액세스하는 암호화폐 지갑
  * 모바일 또는 데스크탑 월렛처럼 개별 플랫폼을 구분할 때 웹 브라우저에서 사용하는 지갑을 특정해 부른다.
  * 장점
    * 트랜잭션을 완료하는 가장 빠른 방법
      * 앱과 서버 위치 사이에 지연이 없다.
    * 소량의 암호화폐 보유에 이상적이다.
    * 일부는 여러 암호화폐를 관리하거나 둘 사이에서 금액을 전송하거나 거래소에 직접 통합할 수 있다.
  * 단점
    * 사용자는 피싱 사기, 맬웨어, 내부자 해킹, DDoS 공격 및 구식 보안 조치에 취약하다.
    * 웹 월렛의 암호화폐 정보는 제 3자에 저장된다.
  * 코인베이스
    * 대표적인 웹 월렛
    * 정해진 종류의 암호화폐만 취급한다.
    * 현재 약 70여종의 암호화폐를 취급한다.
    * 지갑 이외의 다양한 서비스를 제공하는 플랫폼으로 발전하였다.
      * 개인, 기업, 개발자를 위한 서비스가 제공되고 있다.
    * 웹 지갑이기 때문에 모바일 앱의 형태로도 사용할 수 있다.
    * 계정의 스타일에 따라 추적이 불가능한 고급형 지갑을 만들 수도 있다.
    * 악용될 우려도 존재한다.
    * 보안에 위험이 있을 수 있다.
    * 코인베이스 Pro
      * 암호화폐를 구매할 때 사용하는 거래소
      * 지금은 현금 또는 카드 결제를 통해 암호화폐를 구매할 수 있지만 초기에는 코인베이스 프로를 통해서만 암호화폐를 구매할 수 있었다.
      * 바이낸스, 업비트 등과 같은 암호화폐 거래소
      * 거래소마다 핫 월렛과 콜드 월렛의 공개 범위 또는 사용처가 다르다.
* 모바일 월렛
  * 모바일 장치가 있는 곳이면 어디에서나 암호화폐에 엑세스 할 수 있도록 도와준다.
  * 추가 기능을 제공하지만 추가 보안 위험도 따른다.
  * 장점
    * 다른 암호화폐 지갑 유형보다 실용적이고 사용하기 쉽고 즉시 지불을 수락하거나 보낼 수 있다.
    * QR 코드 스캔과 같은 온라인 및 하드웨어 지갑 이상의 추가 기능
  * 단점
    * 휴대폰이 악의적으로 손상되거나 루팅된 경우 지갑 앱 암호화도 위험하다.
    * 휴대폰 자체가 멜웨어, 키로거 및 바이러스에 노출되어있다.
* 데스크탑 월렛
  * 온라인 지갑과 모바일 지갑보다 다소 안전한 것으로 간주된다.
    * 온라인 보안을 잘 적용한 경우에 따라 달라진다.
    * 완전히 오프라인으로 오래 된 랩탑을 사용하는 경우 새로 설치한 운영체제에서 효과적인 콜드 스토리지 방법이다.
  * 장점
    * 사용하기 쉬운 암호화 지갑 유형
    * 타사 서버에 저장되지 않은 개인 키
  * 단점
    * 인터넷에 연결된 경우 보안 및 개인 정보 보호 관련 주의 사항이 있다.
    * 물리적으로 고장난 경우 복구할 방법이 없다.
    * 수리를 맡길 경우 코인을 빼앗길 수 있다.
    * 멜웨어, 키로거 및 바이러스에 노출될 수 있다.
* 하드웨어 월렛
  * 웹, 데스크탑 월렛에 비해 사용자 친화적이지 않다.
  * 종이 월렛보다 작업하기 쉽다.
  * 핫 월렛보다 안전하다.
  * 배터리가 필요한 경우도 있고 필요하지 않은 경우도 있다.
  * 일부는 개인 키를 백업하기 위해 컴퓨터가 필요없다는 것을 의미하는 화면이 있는 경우도 있다.
  * 자주 이동할 필요가 없는 많은 양의 암호화폐를 저장하는 데 적합하며 더 많은 제어 기능을 제공한다.
  * 장점
    * 암호화폐를 장기간 보관하는 가장 안전한 방법
    * 대부분의 경우 모든 지갑보다 강력한 보안
  * 단점
    * 약간 번거롭다.
    * 별도의 사용법을 익혀야 한다.
* 종이 월렛
  * 하드웨어 월렛 이전의 콜드 월렛의 표준
  * 일반적인 종이 월렛, 보안에 특화된 종이 월렛이 있다.
  * 장점
    * 해커로부터 가장 안전한 암호화 지갑 중 하나
    * 대컴퓨터에 저장되지 않는다.
    * 타사 서버에 저장되지 않는 개인 키
  * 단점
    * 약간 번거롭다.
    * 별도의 사용법을 익혀야 한다.
    * 더 많은 기술적 이해가 필요하다.

## UTXO

* Unspent Transaction Outputs
* 미사용 트랜잭션 출력값
* 입력에 의해 생성된 후 다른 입력에 의해 해제되지 않은 트랜잭션 출력
* 이더리움의 어카운트와 달리 계정이나 잔고가 없고, 블록체인에 기록된 소비되지 않은 출력값을 통해 거래의 유효성을 검사하여 코인의 존재 여부를 확인한다. 
* 코인이 지갑이 아니라 UTXO에 저장된다.
* 한 번 사용하고 사라져 익명성과 보안성이 강하다.
* 장점
  * 이중 지불 방지
    * 트랜잭션을 발생시키면 해당 UTXO는 검증을 받은 후 TX Pool에 들어간다.
    * 이중 지불이 발생하면 채굴자들은 Pool에서 UTXO 검사 후 사용 기록이 있다면 해당 거래를 무효화 할 수 있다. 
    * 하이퍼레저 패브릭 Hyperledger Fabric에서도 UTXO를 사용한다.
  * 잔고의 증명
    * 추적하기 용이하다.
    * 거래에 대한 유효성을 검증하기 매우 쉽다.
    * 해당 사용자의 UTXO만 확인하면 되기 때문에 트랜잭션을 모두 검증할 필요가 없다.
* 단점
  * UTXO가 과하게 생성이 될 경우가 있다. 
  * 흩어져있는 UTXO를 모두 모아야 점검할 수 있다.
  * 소액 결제를 엄청 자주 하거나, 채굴로 이자를 받게 되면 과도한 UTXO로 인해 불필요한 수수료를 내야 할 수 있다.
* 잠겨있는 비트코인
* 코인을 담고 있는 상자
  * 다양한 양의 코인을 담을 수 있다.

![UTXO와 트랜잭션 예시](utxo-transaction.png)

* 가격이 6BTC이고, 구매자가 10BTC를 가지고 있을 때 10BTC는 하나의 UTXO에 들어있다.
* 트랜잭션은 입력을 통해 우선 10BTC가 든 출력을 해제한 후에 두 가지 새로운 출력을 만든다.
  * 판매자에게 지불해야하는 6BTC가 든 출력
  * 구매자에게 거슬러줄 4BTC가 든 출력
  * 아직 다른 입력에 의해 해제되지 않았기 때문에 UTXO(미사용 트랜잭션의 출력값)이 된다.
* 확장성이 좋다.
* 로직이 매우 단순하기 때문에 병렬적으로 트랜잭션을 검증할 수 있다.

## HD 지갑

* Hierarchical Deterministic Wallet
* 계층적 결정 지갑
* 하나의 시드 키(Seed Key)를 사용하여 여러 주소를 생성할 수 있는 암호화폐 지갑
* 트리 형태
  * 하나의 부모 키가 여러 개의 연속된 자식 키를 만든다.
  * 자식 키는 다시 여러 개의 손자 키를 만들어내는 방식으로 여러 개의 주소를 생성한다.

### 비결정적 지갑과 결정적 지갑

* 비결정적 지갑
  * 비밀 키를 무작위로 생성하는 방식의 지갑
  * 기본적으로 암호화폐를 사용할 때는 개인 정보 보호를 위해 암호화폐 주소는 재사용하지 않는 것이 가장 바람직하다.
  * 극단적으로는 매 트랜잭션마다 새로운 비밀 키를 생성할 수 있다.  
  * 기존의 지갑은 새로운 비밀 키를 무작위로 추출해 보관해야 한다. 
    * 이런 식으로 매번 무작위로 비밀 키를 생성하다보면, 실수로 지갑 데이터를 분실하는 경우 해당 비밀 키에 저장된 코인과 해당 비밀 키로 생성한 스마트 컨트랙트에 접근하지 못하게 된다. 
    * 지갑 데이터를 자주 백업해야 하는 불편함이 있다.
* 결정적 지갑
  * Deterministic Wallet
  * 비결정적 지갑의 불편함을 해결하는 방식의 지갑
  * 시드 키를 이용한 지갑 방식
  * 결정적 지갑은 하나의 시드에서 하나의 시드 키를 가지고 있다.
    * 시드 키는 비밀 키를 만들기 위한 난수이다. 
    * 비밀 키는 시드 키를 인덱스 또는 다른 데이터와 결합하여 만든다. 
    * 시드 키는 자신으로부터 만들어진 비밀 키를 복구할 수 있다. 
      * 시드 키로부터 만들어지는 모든 비밀 키는 그 값이 미리 정해져 있다.
  * 결정적 지갑을 사용하면 하나의 시드 키만 알고 있어도 시드 키에서 파생된 모든 비밀 키를 알 수 있다. 
    * 모든 비밀 키를 관리할 필요 없이, 시드 키 하나만을 관리하면 된다.

### BIP 32

* 결정적 지갑을 이진 트리 형식으로 계층화하여 끝없이 비밀 키를 생성할 수 있는 구조를 제안
* BIP32에서 제안한 지갑 구조를 프로그래밍화 한 것
* HD 지갑은 BIP32에서 처음 제안되었고, BIP39, BIP44 등 여러 버전이 존재

### HD 지갑 구조

* HD 지갑은 시드 키로부터 마스터 키를 하나 생성한다. 
* 마스터 키로부터 자식 키를 생성한다. 
* 자식 키의 갯수는 2^32개(4,294,967,295개) 생성할 수 있으며, 각 자식 키는 0부터 2^32-1까지 인덱스가 붙게 된다.
* 자식 키
  * 일반 자식 키(Normal Child Key)
    * 일반 자식 키는 0~2^31-1번째 인덱스까지
    * 일반 자식 키는 부모 키의 공개 키를 통해 자신의 공개 키를 구할 수 있다.
  * 단절 자식 키(Hardened Child Key)고, 
    * 단절 자식 키는 2^31~2^32-1번째 인덱스까지
    * 단절 자식 키는 부모의 비밀 키를 알아야 자신의 공개 키를 구할 수 있다. 
      * 부모 키와 연관 없어 보이는 공개 키를 만들기 위해서는 단절 자식 키를 사용해야 한다.
  * 자식 키를 표기할 때는 m(마스터 키)/n번째 자식/m번째 손자 방식으로 표기한다. 
    * 예
      * 마스터 키에서 나온 3번째 자식으로부터 나온 20번째 키를 가리킬 때는 m/3/20이 되며, 단절 자식 키는 m/3/20'으로 표기한다.

### DRBG

* Deterministic Random Bits Generate
* 컴퓨터로 만든 난수를 해시함수를 통해 진짜 난수로 만드는 알고리즘
  * 일반적으로 컴퓨터가 만들어내는 난수는 예측이 가능한 가짜 난수이기 때문에 안전하지 않다.
    * 컴퓨터로 만들어낸 난수를 해싱한 값을 사용한다.
    * 해시 알고리즘이 공개되지 않는 이상 해싱한 값은 완전한 난수이기 때문이다.
* HD 지갑에서는 시드 키를 생성할 때 DRBG를 사용한다.

### HMAC-SHA512

* HD 지갑에서는 부모 키를 통해 자식 키를 확인할 수 있어야 한다.
* HMAC 방식을 사용하여 자식 키를 만든다.
* HMAC-SHA512는 부모의 키 값을 패딩하여 XOR 연산을 하고, 그 결과값을 해싱한다.
* 마스터 키는 시드 키에 HMAC-SHA512를 연산한 결과값이다.

### BIP 44

* 여러 계정이 여러 목적에 맞게 여러 지갑을 사용할 수 있는 HD 지갑 구조
* 목적
  * 항상 44로 설정된다.
* 코인 종류
  * 어떤 종류의 코인인지 나타낸다. 
  * SLIP0044 문서에 각 코인의 종류와 할당된 번호가 있다.
* 계정
  * 사용자는 자신의 지갑을 논리적 계정으로 나눌 수 있다. 
  * 가령 m/44'/0'/0'과 m/44'/0'/1'은 하나의 HD 지갑에 2개의 비트코인 계정이 있다.
* 잔액 계정 여부
  * 비트코인의 잔액 계정 여부. 
  * 하위 트리에 있는 값이 입금 주소인지 잔액 주소인지 표기하며, 잔액 주소이면 1을 넣고, 아니면 0을 넣는다. 
  * 이더리움에서는 UTXO가 아닌 어카운트 기반이기 때문에 늘 잔액 주소가 필요없어 늘 이 값이 0이다.
* 사용 가능한 주소
  * 입금 주소나 잔액 주소를 표기한다.

```
M/44'/60'/0'/0/2 : 이더리움 계정에 대한 세 번째 수신 공개키
M/44'/0'/3'/1/14 : 4번째 비트코인 계정의 15번째 주소 변경 공개키
m/44'/2'/0'/0/1 : 트랜잭션 서명을 위한 라이트코인 메인 계정의 두 번째 개인 키
```

## 기타 월렛

* 브레인 월렛(Brain Wallet)
  * 비밀 키를 랜덤하게 생성하지 않고, 일련의 단어 목록이나 문장(Seed Phrase)를 사용해 비밀 키를 만드는 지갑
    * 장점
      * 비밀 키를 만들 때 사용한 단어 목록이나 문장을 기억하고 있으면 언제든지 비밀 키를 복구할 수 있기 때문에 저장 방식이 간편하다.
      * 사용자에게 익숙한 문장을 시드로 삼는 경우 어딘가에 기록하지 않고도 사용할 수 있기 때문에 안전하다.
    * 단점
      * 사용자가 비밀 키를 생성할 때 사용한 단어 목록이나 문장을 잊어버리는 경우, 해당 비밀 키에 있는 자산에 영영 접근할 수 없게 된다.
      * 인간이 만들어내는 문장은 컴퓨터가 만들어내는 난수에 비해 임의성(Randomness)가 부족하기 때문에, 무차별 대입 공격을 통해 비밀 키를 해킹당할 수 있다.
* 스마트 컨트랙트 월렛
  * 일반적으로 이더리움에서 사용자는 EOA 로 자신의 자산을 관리한다.
    * EOA 에는 코드(스마트 컨트랙트)를 담을 수 없기 때문에 기능이 제한적이다.
  * CA를 사용해 자산을 관리하는 경우, CA에 있는 컨트랙트 코드를 이용해 누가 어떤 조건에서 자산에 접근할 수 있는지를 프로그래밍화 할 수 있다.
    * 이러한 방식의 월렛은 스마트 컨트랙트를 이용한다 하여 스마트 컨트랙트 월렛이라 부른다.
    * 개인 키가 아닌 스마트 컨트랙트로 관리하기 때문에, 기존의 단일 키를 사용하는 EOA 기반 월렛보다 더 높은 수준의 보안, 유연성, 편의성을 제공한다.
    * 사용자는 스마트 컨트랙트 코드를 사용해 멀티 시그 트랜잭션, 일일 송금 제한, 긴급 계정 동결, 안전한 계정 복구 등 고급 기능을 사용할 수 있다.
    * 다른 dApp과도 상호작용 할 수 있다.
  * 많이 사용되는 스마트 컨트랙트 월렛
    * InstaDApp
      * InstaDApp은 다양한 금융 프로토콜을 통합하여 이더리움 및 기타 암호화폐를 사용한 대출 시스템을 제공한다. 
      * 또한 토큰을 유동성 풀에 추가하여 수익을 얻을 수 있는 유니스왑과도 통합되어 있다.
    * Zerion
      * Zerion은 다양한 프로토콜과 대출과 같은 코어 금융 서비스를 제공한다. 
      * 또한 유니스왑을 사용한 토큰 교환, 뱅커와 유니스왑 유동성 풀을 사용한 수익화를 지원한다.
    * Metamask
      * Metamask는 암호화폐 보안 뿐만 아니라 다양한 dApp과 상호작용 할 수 있도록 지원한다.
      * Metamask를 지원하는 dApp에서 토큰을 구입하거나 대여, 또는 수익화하거나, NFT를 교환하고 게임을 하는 등 다양한 활동을 할 수 있다.
* 멀티 시그 월렛
  * Multi-Signature Wallet
  * 스마트 컨트랙트 월렛의 한 종류
  * 멀티시그(Multi-Sig)를 통해서만 송금이 가능하다는 특징이 있다.
  * 핫 월렛과 콜드 월렛의 단점 보완
    * 핫 월렛과 콜드 월렛
      * 하나의 개인 키를 사용하기 때문에 단일 키가 노출될 경우 탈취자가 해당 개인 키에 연결된 자산에 쉽게 접근할 수 있다.
  * 하나의 지갑에 N명의 사용자가 지갑에 대한 소유 권한을 가지고, 해당 지갑에서 트랜잭션을 만들기 위해서는 N명 중 k명이 트랜잭션에 서명을 해야 한다.
  * 이더리움 상에서 구현할 때
    * 멀티 시그 월렛을 위한 스마트 컨트랙트를 만들어 N명 중 k명이 서명해야 컨트랙트를 이행한다는 서명 제한 룰을 추가
    * 실제로 k명이 멀티 시그 월렛 컨트랙트에 트랜잭션을 보내야한다. 
  * 일반 지갑에 비해 보안이 우수하다는 장점이 있으며, 실수로 송금이 일어나는 경우를 방지할 수 있다.
    * N명 중 1명이 실수로 송금 트랜잭션을 생성해도, 나머지 N-1명이 서명을 하지 않으면 트랜잭션이 완료되지 않기 때문이다.
  * 스마트 컨트랙트 상에서 구현되기 때문에 사용성이 부족하다.
    * 대부분의 암호화폐 거래소에서는 일반 지갑 간에 이루어진 트랜잭션만 처리하기 때문에 멀티 시그 월렛에서 일어난 트랜잭션을 인식하지 못하기도 한다.
  * 스마트 컨트랙트 상에서 구현되기 때문에 컨트랙트 코드의 오류로 인해 문제가 발생할 수 있다.
  * 2017년 멀티 시그 월렛을 사용하는 패리티(Parity)에서는 스마트 컨트랙트 버그를 이용한 해킹 사례가 있었다.
  * 멀티 시그 월렛의 예
    * ConsenSys, Gnosis, Argent, BitGo