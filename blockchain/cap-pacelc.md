# CAP 이론과 PACELC 이론

## CAP

* 분산 데이터베이스 시스템을 바탕으로, 네트워크 분할 허용(Network Partition)이 이루어지는 경우에 일관성(Consistency), 가용성(Availability)을 동시에 만족하는 것은 불가능하며, 일관성과 가용성 중 하나만 가질 수 있다는 이론
* 모든 분산 네트워크는 일관성을 지키는 상황(Consistency-Partition Tolerance: CP)과 가용성을 지키는 상황(Availability-Partition Tolerance: AP)으로 나눌 수 있다.
* 모든 노드는 데이터를 업데이트하는 과정에서 다른 작업이 불가능하기 때문에 업데이트가 진행되는 시간에는 일시적으로 데이터베이스에 접속할 수 없어 서비스가 중지된다.
  * 모든 노드에 정보를 업데이트하여 일관성(Consistency)을 지키되 가용성 (Availability)을 포기할 것인가? 
  * 일부 노드에만 정보를 업데이트하여 가용성(Availability)을 지키되 일관성(Consistency)를 포기할 것인가?

### CAP 요소

* 분할 허용(P; Partition Tolerance) : 여러 개의 네트워크가 동작하고 있을 때 접속이 단절되어 서로 메시지를 주고받지 못하더라도 서비스가 잘 동작해야 한다.
* 일관성(C; Consistency) : 분산 시스템에서의 요청 및 응답 과정에서, 노드가 여러 개 있더라도 마치 한 노드에서 실행되는 것처럼 동작해야 한다.
* 가용성(A; Availability) : 분산 시스템이 지속해서 가용하기 위해서 장애 없는(Non-Failing) 노드에 수신된 모든 요청은 반드시 응답돼야 한다.

### CAP의 상관관계

* CA: 일관성과 가용성을 충족하지만 분할 허용을 충족하지 못한다. 데이터에 대한 강한 신뢰를 부여할 수 있지만, 네트워크 문제가 시스템의 중단을 야기할 수 있다.
* CP: 일관성과 분할 허용을 충족하지만 가용성을 충족하지 못한다. 높은 확장성으로부터 성능을 확보할 수 있지만 일부 데이터가 비가용할 수 있다.
* AP: 가용성과 분할 허용을 충족하지만 일관성을 충족하지 못한다. 부정확한 응답을 허용하는 고성능 시스템에 적합하다.

## 네트워크 분할 허용(Network Partition Tolerance)

* 노드 간의 통신이 실질적으로 어려운 상태에 도달하여 네트워크가 사실상 분할(Partition)되었을 때도 네트워크가 정상적으로 작동할 수 있는 경우를 의미
* 네트워크 분할 허용을 전제하는 네트워크
  * 노드 간의 통신이 완전히 불가능
  * 비동기성 네트워크 (Asynchronous Network)에서 메시지가 유실될 수 있다.
  * 현실성이 떨어지는 시간에 메시지가 전달될 수 있다.
  * 최종 사용자(EndUser)입장에서는 문제 없이 네트워크를 이용할 수 있어야 한다.
    * 최종 사용자가 하나의 분산 네트워크가 여러 가지의 노드로 나뉘었다는 사실을 인지하지 못하도록 하여야 한다.
    * 분산 네트워크가 단일 네트워크처럼 보여야 유의미하다.

## 일관성(Consistency)

* 모든 요청은 최신 데이터 또는 에러를 응답 받는다.
* 설명을 위한 생략 
  * 최신 데이터의 전파 속도 및 업데이트 노드 양에 따라서 그 강도가 다르게 분류된다.
  * CAP 이론이 초창기에 소개될 때 어느 강도의 일관성을 의미하는 지에 대해서 실질적으로 명시된 바가 없었다.
  * Linearizability(Atomic/Strong Consistency; 원자성)를 일관성의 기준으로 설정
    * Linearizability
      * Operation A가 성공적으로 종료된 이후에 Operation B가 시작될 때, Operation B는 Operation A의 최종 결과치를 모든 시스템에서 하나의 동일한 상태(The Same State)로 같은 논리적 시간(Logical Time)에 업데이트되어 관찰할 수 있어야 한다는 기준
        * 한 노드에서 특정 데이터의 처리가 완료되었을 때 다른 노드가 동시 다발적으로 업데이트된 정보에 접근할 수 있어야 한다.
        * 매우 강력한 형태의 일관성을 요구
  * 증명을 위하여 읽기와 쓰기 권한만을 싱글 스레드로 순차적으로 처리하는 간단한 서비스로 가정

## 가용성 (Availability)

* 정상적으로 이루어진 모든 요청은 정상적으로 작동하고 있는 모든 노드로부터 응답을 받을 수 있다.
* 일반적으로 높은 가용성(High Availability)라고 일컫는 경우
  * 시스템 자체가 모든 요청에 대한 정상적인 응답을 할 수 있다는 것을 전제
    * 모든 요청은 정상적으로 작동하고 있는 노드 중 일부만 응답을 받을 수 있어도 충분하다.
    * 하나의 정상 노드만 응답해도 시스템은 가용이 가능하다고(Available) 말할 수 있다.
    * 높은 가용성을 가정하는 데이터베이스는 현실적인 응답시간(Realistic Response Time)을 고려한다.
* CAP 이론에서 의미하는 가용성
  * 높은 가용성보다 훨씬 높은 난이도를 요구
  * 높은 가용성을 보장하는 서버는 일반적으로 CAP 이론이 주장하는 가용성에 해당하지 않는다.
  * 우선 오류가 없는 노드가 발송한 메시지는 오류가 없는 모든 노드로부터 응답을 받을 수 있어야 한다.
  * 데이터 저장소에 대한 모든 동작이 오류가 없는 모든 노드로부터 성공적으로 리턴을 받아야 한다.
  * 응답시간에 대한 제한을 걸어두지 않는다(Unbounded Response Time).
    * 응답시간(Latency)에 대해 고려하지 않는다.
    * 분산형 네트워크
      * 기본적으로 응답시간이 실사용에 있어서 중요한 고려요소(Consideration)가 된다.
        * 분산형 네트워크는 단일 네트워크보다 속도가 느리다.
        * 모든 또는 일부 데이터를 복제하여 저장하고자 한다.
          * 정보의 전파 과정에서 일정한 시간이 필수적으로 요구되기 때문이다.
          * 하나의 데이터를 복제하여 저장해야 하는 노드의 수가 많아질수록 속도가 느려진다.
            * 속도가 치명적으로 느린 네트워크는 실제 사용하기에 큰 장애가 있다.
        * 가용성은 응답시간과 깊은 관련이 있음에도 CAP 이론에서는 이를 고려하지 않는다.
          * CAP 이론의 가용성에 따르면 아무리 늦게 보내도 받기만 하면 충분하다.
            * 실제 사용시에는 부적합하다
            * CAP 이론이 이야기하는 네트워크 분할 용이성(Network Partition)에 따르면 노드 간의 통신이 완전히 불가능한 경우도 상정하다.
            * 완전한 CP(Consistency-Partition Tolerance) 시스템은 존재할 수 없다.
              * 노드 간의 통신이 끊어진 상황에서 데이터를 업데이트하는 것이 불가능하다.
  * 모든 네트워크는 고립성(Isolated)이 존재한다.
    * 분산 네트워크의 기본적인 특징을 설명하는 ACID 이론에 기반
    * 트랜잭션이 실행이 되는 중에 생성하는 연산의 중간 결과는 다른 트랜잭션이 접근할 수 없다.
    * 트랜잭션을 처리할 때 다른 트랜잭션이 연산 작업 중간에 끼어들지 못한다.
      * 트랜잭션 실행 내역이 연속적이어야 하기 때문이다.

## PACELC Theorem

* CAP 이론에 따르자면 일관성과 가용성은 완전한 대립 관계에 있다.
* 사실 완벽한(Perfect) CP 시스템과 AP 시스템은 쓸모가 없다.
* 완벽한 CA 시스템은 가질 수 없다.
* 완벽한 CP
  * 완벽한 일관성을 갖는 분산 시스템에서는 하나의 트랜잭션에 대한 복사본을 모든 노드가 가져야 한다. 
  * 시스템의 전체 성능은 네트워크에서 가장 낮은 성능의 노드에 종속된다.
  * 만일 단 하나의 노드라도 문제가 발생하면 트랜잭션 처리는 실패한다.
  * 노드의 수가 많아질수록 지연시간이 길어진다.
* 완벽한 AP
  * 완벽한 가용성을 갖는 분산 시스템은 네트워크 분할로 인해 고립된 노드가 발생하더라도 서비스를 제공한다. 
  * 고립된 노드는 업데이트를 반영하지 못해 일관성이 결여된 잘못된 정보를 가지고 있지만, 완벽한 AP 시스템에서는 어찌 됐건 가용하다. 
  * 사용자는 잘못된 정보를 받고 활용하게 된다.
* 완벽한 CA
  * 완벽한 CA 시스템을 위해선 절대로 장애가 발생하지 않는 네트워크를 구성해야 한다. 
    * 앞서 살펴봤듯이 이는 불가능한 일이다.
* 일관성과 가용성의 절충안에 해당하는 연속적인 중간 영역이 존재한다.
  * Daniel Abadi가 제시한 PACELC이론
    * 중간 영역을 고려하고 네트워크의 정상 상황과 분할 상황을 모두 담아낼 수 있는 표현법
* 분할(Partition)이 발생했다면 가용성(Availability)과 일관성(Consistency) 사이의 트레이드-오프가
  * 그렇지 않다면(Else) 지연시간(Latency)과 일관성(Consistency) 사이의 트레이드-오프가 있음을 의미한다.
  * 네트워크 분할 상황
    * 분할 상황(P)에서는 단절된 노드에 접근할 수 없기 때문에 일관성을 포기하고 가용성을 제공할지(PA),가용성을 포기하고 일관성을 유지할지(PC)의 정도를 결정해야 한다.
  * 네트워크 정상 상황
    * 정상 상황(E)에서는 모든 노드에 업데이트를 반영해 일관성을 유지하기 위한 긴 대기 및 응답시간을 가질지(EC), 일관성을 포기하고 짧은 지연시간을 가질지(EL)의 정도를 결정해야 한다.
* 블록체인에서 네트워크 분할은 분기라는 논리적 사건을 이유로 발생하기도 한다.
  * 비슷한 시점에 같은 높이의 블록이 채굴되거나 새로운 원장이 제시될 경우 분기가 발생한다.
  * 네트워크는 일시적인 분할 상황에 처한다.
  * 시간이 지남에 따라 포크 선택 규칙에 의해 하나로 합의하게 된다.
* CAP 관점에서 보면 블록체인은 가용성과 분할 허용을 충족하는 AP 시스템
  * 통상의 AP 시스템은 고성능을 위하지만 블록체인 시스템은 자가 제한을 통해 성능을 제한한다는 점이 특이하다.
    * 이를 통해 과거 블록의 위/변조를 어렵게 만들고 궁극적 일관성을 확보한다.
      * 블록체인 트릴레마
* 블록체인은 일관성보다는 가용성과 지연시간을 중시한 분산 시스템
  * 시간이 지남에 따라 과거의 블록 및 트랜잭션에 대한 궁극적 일관성을 확보
  * 네트워크 분할 상황
    * 분할 상황에서 블록체인은 일관성보다는 가용성에 초점을 둔다. 
    * 채굴자는 자신이 참조하고 있는 블록이 네트워크에서 아직 합의를 이루지 못했다 할지라도 이전 블록으로 삼아 채굴을 이어간다.
  * 네트워크 정상 상황
    * 정상 상황에서 블록체인은 일관성보다는 짧은 지연시간에 초점을 둔다. 
    * 블록체인에서는 채굴된 새 블록 혹은 더 무거운 체인 등을 통해 원장의 업데이트가 제안되는데, 모든 노드가 이를 따를 필요는 없다.
* 블록체인은 가용성과 지연시간을 중시하지만 충분한 완결성이 부여된 블록에 대해서는 높은 확률로 일관성을 보장하는 분산 시스템이다.
* 블록은 상태와도 같으므로, 현재 상태에 대해서는 가용성과 지연시간을 중시하고 과거 상태에 대해서는 일관성을 중시하는 분산 시스템이다.