# Blockchain

## 자료구조로써의 블록체인

* 인터넷 상에 있는 사람들과 동일한 데이터를 가지는 것
* 누구나 데이터를 추가할 수 있다.
* 데이터는 한 번 추가되면 수정하거나 삭제할 수 없다.
* 개인이나 단체가 데이터를 관리하는 것이 아니라 블록체인 네트워크에 있는 모든 사람들이 함께 관리한다.
* 좁은 의미의 블록체인
  * 데이터를 블록에 담고, 각 블록을 체인처럼 연결한 데이터 구조
  * 과거의 거래기록부터 현재까지의 거래기록들을 블록에 담아, 각 블록을 연결하여 과거의 기록에 대한 위변조 등이 불가능하고 해킹 시도를 방지하는 기술
  * 시간의 흐름을 따라서 수직적으로 연결되는 기술
* 넓은 의미의 블록체인
  * '블록체인'이라는 구조의 데이터를 분산 원장 기술을 사용해 P2P 네트워크 내 여러 노드가 공유하는 것
  * 네트워크의 모든 노드들은 동일한 블록체인 형태의 데이터 사본을 가진다.
  * 모든 노드가 동일한 데이터를 가질 수 있게 하기 위해 합의 알고리즘을 사용한다.
  * 넓은 의미의 블록체인은 분산 원장 기술과 합의 알고리즘을 사용해 블록체인 형태의 데이터를 공유하고 관리하는 데이터베이스

### 블록

* block
* 데이터를 저장하는 공간
* 자산에 대한 정보를 담거나 개인정보를 암호화해서 담는 등 다양한 유형의 정보를 담을 수 있다.
* 어떤 종류의 데이터를 저장하느냐에 따라 블록의 구성이 결정된다.
* 암호화폐에서는 블록에 거래기록을 저장한다.
  * Transaction
    * 거래기록
    * A가 B에게 0.01 비트코인을 전송했다 등
    * 송금자에 대한 정보, 송금자의 잔액, 보내려는 금액, 수신자에 대한 정보
    * 사용자가 직접 자신의 자산에 대한 소유권을 증명하기 위한 디지털 서명을 추가한다.

#### 블록 생성

* 블록체인 네트워크에서 거래가 발생하여 새로운 트랜잭션이 생기면 이 트랜잭션이 네트워크 내에 있는 모든 노드들에 공유된다.
* 블록체인에서 다양한 검증 절차를 수행한다.
* 노드들은 공유받은 트랜잭션이 실제 송금자가 만든 트랜잭션이 맞는지, 악의적인 사용자가 타인을 사칭하는 것은 아닌지, 트랜잭션이 만들어지고 난 후 수정되지는 않았는지 검사한다.
  * 노드
    * 네트워크에 장치 또는 데이터 지점을 의미한다. 네트워크에 접속해있어 연결될 수 있는 컴퓨터를 지칭한다.
    * P2P로 연결되어 블록 체인 네트워크에 연결된 모든 블록 정보를 가지는 각각의 서버
    * 풀 노드
      * 모든 기능을 다 가지고 있는 노드
    * 라이트 노드
      * 모든 블록정보의 원본을 가지고 있지 않고 일종의 요약본 즉 헤더정보만 가지고 있는 노드
* 트랜잭션에 대한 유효성 검사가 끝나고 트랜잭션이 블록에 담기고, 해당 블록이 체인에 추가되어 블록체인의 일부가 될 때 트랜잭션에 대한 처리가 완료된다.
* 채굴
  * 트랜잭션들을 모아서 하나의 블록으로 만드는 과정
  * 암호화폐의 거래내역을 기록한 블록을 생성하고 그 대가로 암호화폐를 얻는 행위
  * 트랜잭션을 처리하는 작업
  * 암호화폐 시스템에서 송금 처리 의미
  * 암호 화폐 송금 서비스를 운영하는 핵심 역할
    * 채굴 노드에게 보상이 주어진다.
* 채굴 경쟁에 참여한 노드가 저마다 블록을 만들어 네트워크에 전파하고, 이 경쟁에서 승리한 노드가 생성한 블록이 채택된다.
* 블록을 받은 노드들은 해당 블록이 유효한지 확인하고 해당 블록이 유효하다면 체인에 추가한다.
* 채굴 노드는 블록 생성에 대한 보상으로 코인을 받고, 발행된 코인은 블록체인 네트워크 내에서 화폐의 역할을 하게 된다. 

### 체인
  
* chain  
* 블록 하나에 거래를 전부 기록하려고 하면 편의성이 떨어진다.
* 하나의 블록에 일정한 갯수의 트랜잭션을 넣어 네트워크에 공유하면 새로운 블록을 만들어 새롭게 생긴 트랜잭션들을 담는다.
* 새로운 블록에는 이전 블록을 지칭하는 데이터를 함께 넣어 직전 블록이 어떤 블록인지 지정한다.
* 일정량의 트랜잭션이 생길 때마다 해당 트랜잭션들을 블록에 넣고, 이전 블록을 가리키는 주소값을 함께 넣는 모양이 체인처럼 연결되어있어 데이터 구조를 블록체인이라고 부른다. 

### 분산원장과 블록체인

* 원장
  * 거래 내역의 집합
  * 블록체인은 원장을 저장하는 데이터베이스 유형 중 하나이다.
* 분산 원장
  * Distributed Ledger
  * 분산되어 있으며 데이터를 여러 위치에 두거나 여러 사용자들이 나눠서 가지고 있는 데이터베이스 유형
  * 분산 원장 시스템에서 데이터를 저장하기 위해서는 데이터를 공유하고 있는 당사자들이 합의해야 하며, 당사자들의 합의를 통해 분산되어 있는 데이터베이스들이 하나의 일관된 데이터를 가질 수 있다.
* 블록체인
  * 특정 기술들이 추가된 분산 원장의 한 종류
  * 네트워크 내 모든 노드들이 새로운 블록에 대한 유효성을 검증하고 난 후에 블록을 체인에 추가할 수 있다.
  * 합의 알고리즘을 사용하는 분산 원장 기술

#### 분산원장과 블록체인의 차이

* 블록체인
  * 그외 다른 분산 원장 데이터베이스 모두 거래 정보를 기록한 원장을 특정 기관의 중앙화된 서버가 아닌 분산화된 네트워크에서 참여자들이 공동으로 기록 및 관리하는 기술
  * 분산원장에서 필요로 했던 인증기관 문제를 합의 알고리즘과 채굴, 노드로 문제를 해결
  * 탈중앙화, 자동화의 특성은 금융 인프라 구조를 개선하는데 기여할 수 있다.
    * 블록체인이 가진 특징이 금융과 접목된다면 발생하는 장점으로 금융인프라에 구조적인 변화를 가져올 수 있다.
    * 국제 송금을 비롯한 대부분의 금융 서비스는 블록체인 도입을 통해 자동화율과 효율성을 높이고, 사고나 사기의 발생률을 낮출 수 있다.
* 블록 구조
  * 블록체인은 일반적으로 블록 형태로 데이터가 저장된다.
  * 분산원장은 여러 노드에 데이터를 분산시켜 저장하는 데이터베이스이다. 블록형식이 아닌 다양한 방식으로 데이터를 저장할 수 있다. 
* 순서
  * 블록체인은 모든 블록이 직전 블록을 가리킴으로써 순서대로 배열되어 있다.
  * 분산원장에서는 데이터를 꼭 순서대로 저장하지는 않는다.
* 블록 생성 매커니즘
  * 블록체인은 생성할 노드를 정하기 위해 PoW, PoS와 같은 매커니즘을 사용한다. 보통 이런 매커니즘은 자원을 소모하게 한다.
  * 분산원장에서는 블록을 경쟁적으로 생성하지 않는 매커니즘을 사용하는 경우도 있다.
* 토큰
  * 블록체인은 블록을 생성하기 위해 자원을 소모한 노드에게 보상을 주기 위해 코인을 제공하며, 이 코인이 화폐의 역할을 한다.
  * 자원을 소모해서 블록을 생성하기 때문에 블록체인에는 코인이 필수적이다.

## 블록체인 도입을 위한 기술적 과제

* 거래 비밀성, 권한 통제, 신뢰 및 보안 유지, 확장성 확보 등의 기술적 과제
  * 블록체인에 저장되는 정보는 개인 정보이기 때문에 소유자와 합의된 관리자만 거래 내역에 접근이 가능해야 한다.
  * 신뢰와 보안 유지를 위해서는 비트코인과 같은 퍼블릭 블록체인을 도입하는 것도 고려해야 한다.
  * 실제 사용이 가능하게 하기 위해서는 적어도 초당 3,000건 이상 처리할 수 있는 성능을 보유한 블록체인이 필요하다.
  * 분산 원장 기술이 금융에 적용될 경우 발생할 수 있는 검증되지 않은 요소들(보안상의 위험, 법적인 위험성 증가)도 있다.
    * 스마트 계약(Smart Contract)을 분산원장기술과 결합해서 사용할 경우,
    소프트웨어 자체의 오류 혹은 의도적인 디도스 공격으로 스마트 계약이 무효화되는 등의 위험성이 있을 수 있다.
* 금융권의 입장에서 가장 중요한 점은 대량의 거래 데이터를 신속하고 안전하게 처리하는 것
* 블록체인 기반의 분산 원장 기술을 금융 서비스에 도입하는 것은 인프라 구축 비용 절감, 거래 효율성 증가, 안전성 향상 등의 측면에서 많은 이점이 있다.
* 거래 비밀성, 권한 통제, 신뢰 및 보안 유지, 확장성 확보 등 기술적 과제 해결이 우선이다.

## segwit

* 세그윗
* Segregated Witness의 약자
* 비트코인의 블록에서 디지털 서명 부분을 분리함으로써 블록당 저장 용량을 늘리는 소프트웨어 업그레이드
* 블록체인이 지역과 국가를 벗어난 탈중앙화 금융시스템으로 동작하게 하기 위해서는, 강력한 탈중앙화, 보안 그리고 초당 3,000건 이상 트랜잭션을 처리할 수 있는 성능(확장성)이 필요하다.
* 비트코인에서 TPS(초당 트랜잭션 처리 수)를 늘려 확장성을 개선하기 위해 한 시도

### 등장 배경

* 2008년 처음 사토시의 Peer-to-Peer Electronic Cash System에서 등장
* 초기의 비트코인은 블록의 크기를 제한하지 않았다. 
  * 피니(Hal Finney)는 블록의 크기를 제한하지 않으면 DDoS 같은 공격에 취약하다고 말하며 사토시에게 1MB의 블록 크기를 제안
  * 사토시는 이를 받아들여서 현재의 비트코인 블록 크기로 지정
* 시간이 점차 흐르면서 사람들은 비트코인에 관해서 관심을 가지고 어느샌가 비트코인의 가격이 큰 폭으로 오를 정도가 되면서 문제가 발생
* 2013년에는 비트코인의 거래량이 한 블록에 담지 못할 정도로 많아지게 되었다.
  * 비트코인은 10분당 하나의 블록을 생성하며 하나의 블록에는 약 2,100개의 거래만 입력할 수 있게 되었기 때문에 거래가 빠르게 진행이 안 된다.
  * 10분 거래량이 1만 번 이상 생기게 되면, 최소 5번째 블록부터 확인을 받아서 거래를 처리하게 되고 1시간 이상을 기다려야 하는 문제 발생
  * 비트코인은 캐시 시스템 즉, 전자화폐의 개념보다는 가치를 저장하는 금(Gold)과 같은 모습으로 변질
* 등장
* 비트코인의 블록 구조
  * 디지털 서명 데이터 (75%), 그 외 데이터 (25%)
  * 전체 블록의 크기가 1MB인데, 그 중 디지털 서명 데이터가 75%를 차지
  * 당시 비트코인은 초당 처리할 수 있는 트랜잭션이 단 7TPS 정도로 확장성이 매우 제한적이다.
* 비트코인 관련 커뮤니티에서는 디지털 서명 데이터를 별도의 공간에 저장하고, 대신 블록에 더 많은 트랜잭션을 담자는 제안 등장
* 블록 당 저장용량을 늘리자는 것
* 2017년 8월 1일 기준으로 비트코인은 세그윗을 적용하는 소프트 포크를 진행
  * 그로스톨코인
    * Groestlcoin
    * 기존의 비트코인에서 서명 부분을 분리한 세그윗(Segwit)을 처음으로 활성화한 암호화폐
  * 세그윗을 진행할 경우 중국의 채굴업자들이 사용하던 에이식부스트(AsicBoost) 방식의 비트코인 채굴이 불가능하다.
    * 앤트풀(Antpool), 비아비티씨(viaBTC) 등 중국의 채굴업체들을 중심으로 기존 에이식(ASIC) 채굴기를 사용한 비트코인 채굴을 지속하기 위해 기존 비트코인 블록에서 분리된 비트코인캐시(BCH, Bitcoin Cash)라는 이름의 새로운 암호화폐를 생성했다.

### 특징

* 거래 속도의 확장성 문제를 해결하기 위해 세그윗을 사용한다.
  * 비트코인과 같은 블록체인은 중앙화된 금융 기관에 비해 현저히 속도가 떨어진다.
* 거래하기 위해서는 거래를 하는 당사자의 서명이 필요하다.
  * 서명은 신원을 증명한다.
* 디지털 서명은 서명을 컴퓨터상에서 숫자 등으로 암호화하여 만든다.
  * 돈을 보내는 사람의 개인 키로 암호화한 메세지를 돈을 받는 사람이 돈을 보내는 사람의 공개키로 해석하여 돈을 보내는 사람이 맞는지 신원을 확인하고 증명하는 것
* 블록의 크기를 1MB 내외로 유지하면서 거래를 처리할 수 있는 속도를 더 빨리할 수 있다.
  * 블록
    * 트랜잭션 데이터를 저장하는 공간
    * 디지털 서명을 저장하는 공간
      * 서명이 실제로 차지하는 크기는 크지 않지만, 서명란 자체가 차지하는 부피가 크다.
* 세그윗은 서명 부분을 따로 Witness라는 데이터 영역으로 분리해 더 많은 거래를 처리할 수 있도록 업데이트한다. 
  * 단순히 블록의 크기를 키우는것도 방법이 될 수 있지만 블록의 크기가 더 커진 블록은 더 많은 거래를 의미하며, 이는 곧 블록당 거래 수수료를 더 많이 받을 수 있게 된다.
    * 채굴자들의 이득을 더 볼 수 있게 되나, 소수의 해시파워를 가진 채굴 노드들로 인해 탈중앙화에서 점차 멀어질 수 있다. 
* 거래 가변성 문제
* Transaction Malleability
* 모든 비트코인 거래에는 해당 거래를 식별할 수 있는 거래의 ID(Transaction ID : TXID)를 포함한다. 
  * TXID가 ID라면 TXID를 따라다니는 전자서명은 비밀번호이다.
* 실질적인 거래 내용에는 변화가 없지만, 거래 ID(TXID)만 변경하여 새로운 거래를 만들어 낼 수 있는 일종의 버그
* 두 개 이상의 거래 ID로 서로 다른 거래처럼 보이지만 실제 거래 내역은 동일한 거래를 가질 수 있는 것
  * 거래 ID는 한 사람에게 하나만 주어지는 것이 원칙
  * 거래 내역을 검증하는 것이 노드들의 역할이어서 근본적 문제라고 할 수 없고, 신중하다면 일어나지 않는 문제이다.
    * 발생했을 때 비트코인의 가치는 하락한다.
* 세그윗이 이 TXID를 따로 보관하고 관리함으로써 여러 개의 ID를 가지고 장난을 치거나 동일한 거래 내역 여러 개를 만드는 것을 막을 수 있다.
* 버전 호환
* 세그윗은 하드 포크가 아닌 소프트포크이다.
  * 비트코인 소프트웨어의 업그레이드를 하지 않아도 세그윗 이전과 세그윗 적용 버전을 모든 노드에서 사용할 수 있다.
* 0.13.1 버전 이전의 비트코인 코어(비트코인 소프트웨어)는 크기가 1MB 이상인 블록은 읽을 수 없다. 
  * 트랜잭션에 대한 주요 입출력 내용은 1MB 안에 들어있고, 디지털 서명 부분만 빠져있기 때문에 호환은 가능
  * 서명 부분이 빠져있기 때문에 구버전의 노드는 이를 검증하지 않고 그냥 받아들인다.
  * 세그윗이 적용된 버전의 노드들은 디지털 서명을 사용해 신원을 증명한다.
* 정리
  * 용량 증가
    * 세그윗의 가장 큰 장점 
    * 트랜잭션 입력값에서 서명 데이터를 제거함으로써, 더 많은 트랜잭션이 단일 블록에 저장될 수 있게 되었다. 
    * 트랜잭션은 입력값과 출력값이라는 두 가지 주요 요소로 구성
      * 입력값에는 전송자의 공개 주소가 포함된다.
      * 출력값에는 수신자의 공개 주소가 포함된다.
    * 전송자는 반드시 전송하려는 자금이 있다는 것을 디지털 서명을 통해 증명해야 한다.
    * 세그윗을 사용하면 트랜잭션 입력값으로부터 서명 데이터가 분리되어 실질 블록 크기는 1MB에서 4MB까지 증가한다.
    * 세그윗을 통해 실제 블록 크기가 증가하는 것은 아니라는 것
      * 세그윗은 블록 크기 제한(하드 포크가 필요함)을 늘리지 않고, 실질 블록 크기를 늘리는 기술적 해결책
      * 실제 블록 크기는 여전히 1MB이지만, 유효한 블록 크기 제한은 4MB
    * 블록 크기라는 개념을 대체하는 블록 무게라는 개념을 도입
      * 모든 블록 데이터를 포함한 것으로, 트랜잭션 데이터(1MB)와 더는 입력 영역의 일부가 아닌 서명 데이터(최대 3MB)를 포함
  * 트랜잭션 속도 증가
    * 더 많은 트랜잭션을 저장할 수 있는 블록을 통해 세그윗은 트랜잭션 속도를 증가시킨다. 
      * 더 많은 트랜잭션이 블록체인에서 진행될 수 있기 때문이다.
    * 하나의 블록을 마이닝 하는 데는 동일한 시간이 소요될 수 있다. 
    * 하나의 블록 안에서 더 많은 트랜잭션이 처리될 수 있다.
      * TPS가 증가한다.
    * 트랜잭션 속도가 증가하면 비트코인 네트워크 트랜잭션 수수료 절감에도 도움이된다. 
      * 수수료를 30분의 1로 줄였다.
  * 트랜잭션 가변성 해결
    * 비트코인의 주된 문제는 잠재적으로 트랜잭션 서명을 조작할 수 있다는 것
      * 서명이 변경되면 두 당사자 간의 트랜잭션에 오류가 생길 수 있다.
    * 블록체인에 저장된 데이터는 사실상 불변하는 것
      * 유효하지 않은 트랜잭션이 블록체인에 영구적으로 저장될 수 있다.
    * 세그윗을 사용하면 서명이 더 이상 트랜잭션 데이터의 일부가 아니기 때문에 해당 데이터를 변경할 수 없다.
      * 해결책은 블록체인 커뮤니티 내에서 세컨드 레이어 프로토콜과 스마트 콘트랙트와 같은 추가적인 혁신이 이뤄질 수 있다. 
  * 세그윗 2x와 비교
    * 세그윗
      * 소프트 포크 업그레이드
        * 이전 버전과 호환이 가능
        * 세그윗을 포함하도록 업데이트 되지 않은 비트코인 노드도 여전히 트랜잭션을 처리할 수 있다.
      * 비트코인 커뮤니티의 지지를 얻고 시행
      * UASF(User-Activated Soft Fork)의 개념을 만들어냈다.
        *  사용자 활성 소프트 포크
    * 세그윗 2x
      * 하드포크가 필요하다.
      * 단지 트랜잭션을 일괄 처리하는 방식을 변화시킬 뿐만 아니라, 블록 크기를 증가(1MB에서 2MB로)시킨다.
        * 블록 크기가 커지면 더 많은 데이터를 처리해야 하기 때문에 노드 운영자와 마이너의 부담이 증가할 수 있다.
      * 비트코인 거버넌스의 기본 규칙 중 하나에 실질적인 변화를 제안
      * 개발자들이 채택과 이행에 대한 합의를 달성하지 못했기 떄문에 중단됐다.